{% extends 'base.html' %}
{% block title %} Products {% endblock %}
{% block content %}

<div class="p-4 mt-6">
    <!-- Header with Breadcrumb -->
    <div class="mb-4">
        <nav class="flex text-sm text-gray-500" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/dashboard" class="hover:text-blue-600 flex items-center gap-1">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-3 h-3 mx-1" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path></svg>
                        <span class="text-gray-700 font-medium">Products</span>
                    </div>
                </li>
            </ol>
        </nav>
    </div>

    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-black text-gray-400 flex items-center gap-2">
                <i class="fas fa-box"></i> Product Inventory
            </h2>
            <p class="text-sm text-gray-500 mt-1">Manage your products and track stock levels in real-time</p>
        </div>
        
        <div class="flex gap-3">
            <button id="printBtn" class="text-white bg-gray-600 hover:bg-gray-700 font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-print"></i> Print
            </button>
            <button id="exportBtn" class="text-white bg-green-600 hover:bg-green-700 font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Export
            </button>
            <button data-modal-target="product-modal" data-modal-toggle="product-modal" class="text-white bg-[#3f6995] hover:bg-[#2d4d6e] font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Add Product
            </button>
        </div>
    </div>

    <!-- Enhanced Quick Stats with Icons and Gradients -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Total Products</p>
                    <h3 class="text-4xl font-black mt-2">{{ products|length }}</h3>
                    <p class="text-xs opacity-75 mt-1">In your catalog</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-box-open"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">In Stock</p>
                    <h3 class="text-4xl font-black mt-2">{{ in_stock_count }}</h3>
                    <p class="text-xs opacity-75 mt-1">Available to sell</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 {% if low_stock_count > 0 %}animate-pulse{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Low Stock Alert</p>
                    <h3 class="text-4xl font-black mt-2">{{ low_stock_count }}</h3>
                    <p class="text-xs opacity-75 mt-1">Need restocking</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Inventory Value</p>
                    <h3 class="text-3xl font-black mt-2">Ksh {{ "{:,.0f}".format(total_inventory_value) }}</h3>
                    <p class="text-xs opacity-75 mt-1">Total worth</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-wallet"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-2xl shadow-lg mb-6 p-4 border border-gray-100">
        <div class="flex flex-wrap gap-2">
            <button class="filter-btn active px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2" data-filter="all">
                <i class="fas fa-th-large"></i> All Products ({{ products|length }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2" data-filter="in-stock">
                <i class="fas fa-check-circle"></i> In Stock ({{ in_stock_count }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2" data-filter="low-stock">
                <i class="fas fa-exclamation-circle"></i> Low Stock ({{ low_stock_count }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2" data-filter="out-stock">
                <i class="fas fa-times-circle"></i> Out of Stock
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2" data-filter="high-margin">
                <i class="fas fa-gem"></i> High Margin (>50%)
            </button>
        </div>
    </div>

    <!-- Table with enhanced styling -->
    <div class="relative overflow-x-auto shadow-2xl sm:rounded-3xl bg-white p-6 border border-gray-100">
        <table id="productsTable" class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                <tr>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-hashtag mr-1"></i> ID</th>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-tag mr-1"></i> Product Name</th>
                    <th scope="col" class="px-6 py-4 text-right font-bold"><i class="fas fa-shopping-cart mr-1"></i> Buy Price</th>
                    <th scope="col" class="px-6 py-4 text-right font-bold"><i class="fas fa-money-bill-wave mr-1"></i> Sell Price</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-boxes mr-1"></i> Stock</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-info-circle mr-1"></i> Status</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-percentage mr-1"></i> Margin</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-cog mr-1"></i> Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                {% set stock = available_stock(product.id) %}
                {% set margin = ((product.selling_price - product.buying_price) / product.buying_price * 100) %}
                <tr class="bg-white border-b hover:bg-blue-50 transition-all duration-200 cursor-pointer
                    {% if stock == 0 %}out-of-stock{% elif stock < 5 %}low-stock{% else %}in-stock{% endif %}
                    {% if margin > 50 %}high-margin{% endif %}"
                    data-stock="{{ stock }}" data-margin="{{ margin }}">
                    
                    <td class="px-6 py-4 font-bold text-gray-900">
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg">#{{product.id}}</span>
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                                {{ product.name[0].upper() }}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">{{product.name}}</p>
                                <p class="text-xs text-gray-500"><i class="fas fa-barcode mr-1"></i> SKU: PRD-{{product.id}}</p>
                            </div>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-right">
                        <span class="text-gray-600 font-semibold">Ksh {{"{:,.2f}".format(product.buying_price)}}</span>
                    </td>
                    
                    <td class="px-6 py-4 text-right">
                        <span class="text-blue-600 font-bold text-lg">Ksh {{"{:,.2f}".format(product.selling_price)}}</span>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-2xl font-black {% if stock < 5 %}text-red-600{% elif stock < 20 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{stock}}
                            </span>
                            <span class="text-xs text-gray-500">units</span>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        {% if stock == 0 %}
                            <span class="bg-red-100 text-red-800 text-xs font-bold px-3 py-1.5 rounded-full inline-flex items-center gap-1">
                                <i class="fas fa-times-circle"></i>
                                Out of Stock
                            </span>
                        {% elif stock < 5 %}
                            <span class="bg-red-100 text-red-800 text-xs font-bold px-3 py-1.5 rounded-full animate-pulse inline-flex items-center gap-1">
                                <i class="fas fa-exclamation-triangle"></i>
                                Critical
                            </span>
                        {% elif stock < 20 %}
                            <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1.5 rounded-full inline-flex items-center gap-1">
                                <i class="fas fa-exclamation-circle"></i>
                                Low Stock
                            </span>
                        {% else %}
                            <span class="bg-green-100 text-green-800 text-xs font-bold px-3 py-1.5 rounded-full inline-flex items-center gap-1">
                                <i class="fas fa-check-circle"></i>
                                In Stock
                            </span>
                        {% endif %}
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-xl font-black {% if margin > 50 %}text-green-600{% elif margin > 20 %}text-blue-600{% else %}text-gray-600{% endif %}">
                                {{"{:.1f}".format(margin)}}%
                            </span>
                            <span class="text-xs {% if margin > 50 %}text-green-600{% elif margin > 20 %}text-blue-600{% else %}text-gray-500{% endif %}">
                                {% if margin > 50 %}<i class="fas fa-star"></i> Excellent{% elif margin > 20 %}<i class="fas fa-thumbs-up"></i> Good{% else %}<i class="fas fa-minus-circle"></i> Low{% endif %}
                            </span>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded-lg transition-all" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-600 hover:text-green-800 p-2 hover:bg-green-100 rounded-lg transition-all" title="Restock">
                                <i class="fas fa-box"></i>
                            </button>
                            <button class="text-yellow-600 hover:text-yellow-800 p-2 hover:bg-yellow-100 rounded-lg transition-all" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Keep your existing modal -->
<div id="product-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-3xl shadow-2xl">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i> Add New Product
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="product-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <div class="p-4 md:p-5">
                <form class="space-y-4" action="/add_products" method="post">
                    <div>
                        <label for="product_name" class="block mb-2 text-sm font-medium text-gray-900 flex items-center gap-1">
                            <i class="fas fa-tag"></i> Product Name
                        </label>
                        <input type="text" name="product_name" id="product_name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-2.5" placeholder="e.g. Oversized Hoodie" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="buying_price" class="block mb-2 text-sm font-medium text-gray-900 flex items-center gap-1">
                                <i class="fas fa-shopping-cart"></i> Buying Price
                            </label>
                            <input type="number" name="buying_price" id="buying_price" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-2.5" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="selling_price" class="block mb-2 text-sm font-medium text-gray-900 flex items-center gap-1">
                                <i class="fas fa-money-bill-wave"></i> Selling Price
                            </label>
                            <input type="number" name="selling_price" id="selling_price" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-2.5" placeholder="0.00" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full text-white bg-[#3f6995] hover:bg-[#2d4d6e] focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-xl text-sm px-5 py-3 text-center transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-check"></i> Add Product to Inventory
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    /* Filter button styles */
    .filter-btn {
        background: #f3f4f6;
        color: #6b7280;
    }
    .filter-btn:hover {
        background: #e5e7eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .filter-btn.active {
        background: linear-gradient(135deg, #3f6995 0%, #2d4d6e 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(63,105,149,0.3);
    }
    
    /* Row animation */
    tbody tr {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    $(document).ready(function() {
        var table = $('#productsTable').DataTable({
            "pageLength": 10,
            "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            "language": {
                "search": "<i class='fas fa-search'></i> Search products:",
                "lengthMenu": "Show _MENU_ products per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ products",
                "infoEmpty": "No products available",
                "infoFiltered": "(filtered from _MAX_ total products)",
                "zeroRecords": "No matching products found",
                "paginate": {
                    "first": "<i class='fas fa-angle-double-left'></i> First",
                    "last": "Last <i class='fas fa-angle-double-right'></i>",
                    "next": "Next <i class='fas fa-angle-right'></i>",
                    "previous": "<i class='fas fa-angle-left'></i> Previous"
                }
            },
            "order": [[0, 'asc']]
        });

        // Filter functionality
        $('.filter-btn').on('click', function() {
            $('.filter-btn').removeClass('active');
            $(this).addClass('active');
            
            var filter = $(this).data('filter');
            
            if (filter === 'all') {
                table.search('').draw();
            } else if (filter === 'in-stock') {
                table.column(5).search('In Stock').draw();
            } else if (filter === 'low-stock') {
                table.column(5).search('Low Stock|Critical', true, false).draw();
            } else if (filter === 'out-stock') {
                table.column(5).search('Out of Stock').draw();
            } else if (filter === 'high-margin') {
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        var margin = parseFloat(data[6]) || 0;
                        return margin > 50;
                    }
                );
                table.draw();
                $.fn.dataTable.ext.search.pop();
            }
        });

        // Export to Excel
        document.getElementById('exportBtn').addEventListener('click', function() {
            var wb = XLSX.utils.table_to_book(document.getElementById('productsTable'), {sheet: "Products"});
            XLSX.writeFile(wb, 'MyDuka_Products_' + new Date().toISOString().split('T')[0] + '.xlsx');
        });

        // Print functionality
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });
    });
</script>

{% endblock %}