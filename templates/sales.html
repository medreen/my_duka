{% extends 'base.html' %}
{% block title %} Sales {% endblock %}
{% block content %}

<div class="p-4 mt-6">
    <!-- Header with Breadcrumb -->
    <div class="mb-4">
        <nav class="flex text-sm text-gray-500" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/dashboard" class="hover:text-blue-600 flex items-center gap-1">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-3 h-3 mx-1" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path></svg>
                        <span class="text-gray-700 font-medium">Sales</span>
                    </div>
                </li>
            </ol>
        </nav>
    </div>

    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-black text-gray-400 flex items-center gap-2">
                <i class="fas fa-cash-register"></i> Sales Records
            </h2>
            <p class="text-sm text-gray-500 mt-1">Track and manage your daily transactions</p>
        </div>
        
        <div class="flex gap-3">
            <button id="printSalesBtn" class="text-white bg-gray-600 hover:bg-gray-700 font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-print"></i> Print
            </button>
            <button id="exportSalesBtn" class="text-white bg-green-600 hover:bg-green-700 font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Export
            </button>
            <button data-modal-target="sales-modal" data-modal-toggle="sales-modal" class="text-white bg-[#3f6995] hover:bg-[#2d4d6e] font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Record Sale
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Total Sales</p>
                    <h3 class="text-4xl font-black mt-2">{{ sales|length }}</h3>
                    <p class="text-xs opacity-75 mt-1">All time transactions</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-receipt"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Today's Sales</p>
                    <h3 class="text-4xl font-black mt-2">{{ today_sales_count }}</h3>
                    <p class="text-xs opacity-75 mt-1">Transactions today</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-calendar-day"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Units Sold</p>
                    <h3 class="text-4xl font-black mt-2">{{ total_units_sold }}</h3>
                    <p class="text-xs opacity-75 mt-1">Total items</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-cubes"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-yellow-500 to-orange-500 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Top Product</p>
                    <h3 class="text-2xl font-black mt-2">{{ top_product_name }}</h3>
                    <p class="text-xs opacity-75 mt-1">Best seller</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-trophy"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Chart -->
    <div class="bg-white rounded-2xl shadow-lg mb-6 p-6 border border-gray-100">
        <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
            <i class="fas fa-chart-line text-blue-600"></i> Sales Trend (Last 7 Days)
        </h3>
        <div class="h-64">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="relative overflow-x-auto shadow-2xl sm:rounded-3xl bg-white p-6 border border-gray-100">
        <table id="salesTable" class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                <tr>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-hashtag mr-1"></i> Sale ID</th>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-tag mr-1"></i> Product Name</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-box mr-1"></i> Quantity</th>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-calendar mr-1"></i> Date</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-cog mr-1"></i> Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in sales %}
                <tr class="bg-white border-b hover:bg-blue-50 transition-all duration-200">
                    <td class="px-6 py-4 font-bold text-gray-900">
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg flex items-center gap-1 w-fit">
                            <i class="fas fa-receipt text-xs"></i> #{{sale.id}}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white font-bold">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">{{sale.name}}</p>
                                <p class="text-xs text-gray-500"><i class="fas fa-barcode mr-1"></i> Product Code</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center"> 
                        <span class="bg-blue-100 text-blue-800 text-sm font-bold px-4 py-2 rounded-full inline-flex items-center gap-1">
                            <i class="fas fa-cubes"></i> {{sale.quantity}} units
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-700"><i class="far fa-calendar-alt mr-1"></i> {{sale.created_at.strftime('%Y-%m-%d')}}</span>
                            <span class="text-xs text-gray-500"><i class="far fa-clock mr-1"></i> {{sale.created_at.strftime('%H:%M')}}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded-lg transition-all" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-600 hover:text-green-800 p-2 hover:bg-green-100 rounded-lg transition-all" title="Print Receipt">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="sales-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-3xl shadow-2xl">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-cash-register text-green-600"></i> Record New Sale
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="sales-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                </button>
            </div>
            <div class="p-4 md:p-5">
                <form class="space-y-4" action="/add_sales" method="post">
                    <div>
                        <label for="product_id" class="block mb-2 text-sm font-medium text-gray-900 flex items-center gap-1">
                            <i class="fas fa-tag"></i> Select Product
                        </label>
                        <select id="product_id" name="product_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-2.5" required>
                            <option value="" disabled selected>Choose product...</option>
                            {% for product in products %}
                            <option value="{{product.id}}">{{product.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block mb-2 text-sm font-medium text-gray-900 flex items-center gap-1">
                            <i class="fas fa-boxes"></i> Quantity Sold
                        </label>
                        <input type="number" name="quantity" id="quantity" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-2.5" placeholder="Enter amount" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-[#3f6995] hover:bg-[#2d4d6e] focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-xl text-sm px-5 py-3 text-center transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> Complete Sale
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function() {
        $('#salesTable').DataTable({
            "pageLength": 10,
            "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            "language": {
                "search": "<i class='fas fa-search'></i> Search sales:",
                "lengthMenu": "Show _MENU_ sales per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ sales",
                "infoEmpty": "No sales available",
                "infoFiltered": "(filtered from _MAX_ total sales)",
                "zeroRecords": "No matching sales found",
                "paginate": {
                    "first": "<i class='fas fa-angle-double-left'></i> First",
                    "last": "Last <i class='fas fa-angle-double-right'></i>",
                    "next": "Next <i class='fas fa-angle-right'></i>",
                    "previous": "<i class='fas fa-angle-left'></i> Previous"
                }
            },
            "order": [[0, 'desc']]
        });

        // Sales Chart
        const ctx = document.getElementById('salesChart');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ sales_chart_labels|safe }},
                datasets: [{
                    label: 'Daily Sales',
                    data: {{ sales_chart_data|safe }},
                    borderColor: '#3f6995',
                    backgroundColor: 'rgba(63, 105, 149, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Export to Excel
        document.getElementById('exportSalesBtn').addEventListener('click', function() {
            var wb = XLSX.utils.table_to_book(document.getElementById('salesTable'), {sheet: "Sales"});
            XLSX.writeFile(wb, 'MyDuka_Sales_' + new Date().toISOString().split('T')[0] + '.xlsx');
        });

        // Print
        document.getElementById('printSalesBtn').addEventListener('click', function() {
            window.print();
        });
    });
</script>

{% endblock %}