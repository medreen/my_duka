{% extends 'base.html' %}
{% block title %} Stock {% endblock %}
{% block content %}

<div class="p-4 mt-6">
    <!-- Header with Breadcrumb -->
    <div class="mb-4">
        <nav class="flex text-sm text-gray-500" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/dashboard" class="hover:text-blue-600 flex items-center gap-1">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-3 h-3 mx-1" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path></svg>
                        <span class="text-gray-700 font-medium">Stock</span>
                    </div>
                </li>
            </ol>
        </nav>
    </div>

    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-black text-gray-400 flex items-center gap-2">
                <i class="fas fa-warehouse"></i> Stock Management
            </h2>
            <p class="text-sm text-gray-500 mt-1">Add and monitor inventory levels for your products</p>
        </div>
        
        <div class="flex gap-3">
            <button id="printStockBtn" class="text-white bg-gray-600 hover:bg-gray-700 font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-print"></i> Print
            </button>
            <button id="exportStockBtn" class="text-white bg-green-600 hover:bg-green-700 font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Export
            </button>
            <button data-modal-target="stock-modal" data-modal-toggle="stock-modal" class="text-white bg-[#3f6995] hover:bg-[#2d4d6e] font-bold rounded-xl text-sm px-5 py-2.5 transition-all flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Restock Product
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Total Stock Entries</p>
                    <h3 class="text-4xl font-black mt-2">{{ stock|length }}</h3>
                    <p class="text-xs opacity-75 mt-1">Restock records</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-clipboard-list"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Total Units Added</p>
                    <h3 class="text-4xl font-black mt-2">{{ total_stock_added }}</h3>
                    <p class="text-xs opacity-75 mt-1">This month</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-boxes"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Latest Restock</p>
                    <h3 class="text-2xl font-black mt-2">{{ latest_stock_product }}</h3>
                    <p class="text-xs opacity-75 mt-1">Most recent</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-truck-loading"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs opacity-90 uppercase font-semibold tracking-wider">Stock Value</p>
                    <h3 class="text-3xl font-black mt-2">Ksh {{ "{:,.0f}".format(stock_value) }}</h3>
                    <p class="text-xs opacity-75 mt-1">Investment</p>
                </div>
                <div class="text-5xl opacity-30">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Activity Chart -->
    <div class="bg-white rounded-2xl shadow-lg mb-6 p-6 border border-gray-100">
        <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
            <i class="fas fa-chart-bar text-teal-600"></i> Stock Activity (Last 7 Days)
        </h3>
        <div class="h-64">
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <div class="relative overflow-x-auto shadow-2xl sm:rounded-3xl bg-white p-6 border border-gray-100">
        <table id="stockTable" class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                <tr>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-hashtag mr-1"></i> Stock ID</th>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-tag mr-1"></i> Product Name</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-boxes mr-1"></i> Quantity Added</th>
                    <th scope="col" class="px-6 py-4 font-bold"><i class="fas fa-calendar mr-1"></i> Date Added</th>
                    <th scope="col" class="px-6 py-4 text-center font-bold"><i class="fas fa-cog mr-1"></i> Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in stock %}
                <tr class="bg-white border-b hover:bg-teal-50 transition-all duration-200">
                    <td class="px-6 py-4 font-bold text-gray-900">
                        <span class="bg-teal-100 text-teal-800 px-3 py-1 rounded-lg flex items-center gap-1 w-fit">
                            <i class="fas fa-clipboard text-xs"></i> #{{item.id}}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-400 to-cyan-500 flex items-center justify-center text-white font-bold">
                                <i class="fas fa-box"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">{{item.name}}</p>
                                <p class="text-xs text-gray-500"><i class="fas fa-warehouse mr-1"></i> Inventory Item</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center"> 
                        <span class="bg-green-100 text-green-800 text-sm font-bold px-4 py-2 rounded-full inline-flex items-center gap-1">
                            <i class="fas fa-plus-circle"></i> {{item.stock_quantity}}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-700"><i class="far fa-calendar-alt mr-1"></i> {{item.created_at.strftime('%Y-%m-%d')}}</span>
                            <span class="text-xs text-gray-500"><i class="far fa-clock mr-1"></i> {{item.created_at.strftime('%H:%M')}}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded-lg transition-all" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-yellow-600 hover:text-yellow-800 p-2 hover:bg-yellow-100 rounded-lg transition-all" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="stock-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-3xl shadow-2xl">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-truck text-teal-600"></i> Update Stock Levels
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="stock-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-5">
                <form class="space-y-4" action="/add_stock" method="post">
                    <div>
                        <label for="product_id" class="block mb-2 text-sm font-semibold text-gray-900 flex items-center gap-1">
                            <i class="fas fa-tag"></i> Select Product
                        </label>
                        <select id="product_id" name="product_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-3" required>
                            <option value="" disabled selected>Search for a product...</option>
                            {% for product in products %}
                            <option value="{{product.id}}">{{product.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="stock_quantity" class="block mb-2 text-sm font-semibold text-gray-900 flex items-center gap-1">
                            <i class="fas fa-boxes"></i> Quantity to Add
                        </label>
                        <input type="number" name="stock_quantity" id="stock_quantity" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-[#3f6995] focus:border-[#3f6995] block w-full p-3" placeholder="e.g. 50" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-[#3f6995] hover:bg-[#2d4d6e] focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-xl text-sm px-5 py-3.5 text-center transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> Update Inventory
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function() {
        $('#stockTable').DataTable({
            "pageLength": 10,
            "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            "language": {
                "search": "<i class='fas fa-search'></i> Search stock:",
                "lengthMenu": "Show _MENU_ stock entries per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ stock entries",
                "infoEmpty": "No stock entries available",
                "infoFiltered": "(filtered from _MAX_ total entries)",
                "zeroRecords": "No matching stock entries found",
                "paginate": {
                    "first": "<i class='fas fa-angle-double-left'></i> First",
                    "last": "Last <i class='fas fa-angle-double-right'></i>",
                    "next": "Next <i class='fas fa-angle-right'></i>",
                    "previous": "<i class='fas fa-angle-left'></i> Previous"
                }
            },
            "order": [[0, 'desc']]
        });

        // Stock Chart
        const ctx = document.getElementById('stockChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ stock_chart_labels|safe }},
                datasets: [{
                    label: 'Stock Added',
                    data: {{ stock_chart_data|safe }},
                    backgroundColor: '#14b8a6',
                    borderColor: '#0d9488',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Export to Excel
        document.getElementById('exportStockBtn').addEventListener('click', function() {
            var wb = XLSX.utils.table_to_book(document.getElementById('stockTable'), {sheet: "Stock"});
            XLSX.writeFile(wb, 'MyDuka_Stock_' + new Date().toISOString().split('T')[0] + '.xlsx');
        });

        // Print
        document.getElementById('printStockBtn').addEventListener('click', function() {
            window.print();
        });
    });
</script>

{% endblock %}